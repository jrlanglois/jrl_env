name: Validate Configuration Files

on:
  push:
    branches: [ main ]
    paths:
      - 'configs/**'
      - 'test/**'
      - 'systems/**'
      - '.github/workflows/validateConfigs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'configs/**'
      - 'test/**'
      - 'systems/**'
      - '.github/workflows/validateConfigs.yml'
  workflow_dispatch:

jobs:
  validate-macos-config:
    name: Validate macOS Config
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax and schema
        run: |
          python3 -m common.systems.validate macos

      - name: Validate macOS packages
        run: |
          python3 test/validatePackages.py configs/macos.json


  validate-windows-config:
    name: Validate Windows Config
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax and schema
        run: |
          python3 -m common.systems.validate win11

      - name: Validate Windows packages
        shell: pwsh
        continue-on-error: true
        run: |
          python3 test/validatePackages.py configs/win11.json

  validate-fonts:
    name: Validate Fonts Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax
        run: |
          python3 helpers/validateJson.py configs/fonts.json

      - name: Validate Google Fonts
        run: |
          python3 test/validateFonts.py configs/fonts.json

  validate-repositories:
    name: Validate Repositories Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax
        run: |
          python3 helpers/validateJson.py configs/repositories.json

      - name: Validate repositories
        run: |
          python3 test/validateRepositories.py configs/repositories.json

  validate-git-config:
    name: Validate Git Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax
        run: |
          python3 helpers/validateJson.py configs/gitConfig.json

      - name: Validate Git config (aliases, name, email, GitHub username)
        run: |
          python3 test/validateGitConfig.py configs/gitConfig.json

  validate-cursor-config:
    name: Validate Cursor Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax
        run: |
          python3 helpers/validateJson.py configs/cursorSettings.json

  validate-linuxcommon-config:
    name: Validate linuxCommon Config
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'configs/linuxCommon.json') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax
        run: |
          python3 helpers/validateJson.py configs/linuxCommon.json

      - name: Validate all package manager sections exist
        run: |
          python3 -c "
          import json, sys
          with open('configs/linuxCommon.json') as f:
              config = json.load(f)
          required = ['apt', 'dnf', 'pacman', 'zypper', 'snap', 'flatpak']
          missing = [pm for pm in required if pm not in config]
          if missing:
              print(f'Missing: {missing}')
              sys.exit(1)
          for pm in required:
              print(f'âœ“ {pm}: {len(config[pm])} packages')
          "

      - name: Validate all packages exist (parallel, all package managers)
        run: |
          echo "Validating packages for apt, dnf, pacman, zypper, snap, flatpak..."
          echo "Using parallel API validation for speed (may take 1-3 minutes)"
          python3 test/validateLinuxCommonPackages.py configs/linuxCommon.json --all
        continue-on-error: true

  validate-linux-distros:
    name: Validate ${{ matrix.distro }} Config
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro:
          - alpine
          - archlinux
          - debian
          - elementary
          - endeavouros
          - fedora
          - linuxmint
          - manjaro
          - mxlinux
          - opensuse
          - popos
          - raspberrypi
          - redhat
          - ubuntu
          - zorin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and dependencies
        uses: ./.github/actions/setupPython

      - name: Validate JSON syntax
        run: |
          python3 helpers/validateJson.py configs/${{ matrix.distro }}.json

      - name: Validate with schema
        run: |
          python3 -m common.systems.validate ${{ matrix.distro }}
